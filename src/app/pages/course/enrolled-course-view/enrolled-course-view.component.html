<p>enrolled-course-view works!</p>

<!-- Nested tab panel for chapters -->
<emr-tab-panel [activeItemId]="selectedChapter ? 'chapter-' + selectedChapter.id : ''" compact class="h-full border-t border-t-default border-b border-b-default border-s border-s-default overflow-x-hidden">
  <emr-tab-panel-header>
    <emr-tab-panel-nav>
      @for (chapter of course?.chapters || []; track chapter.id) {
        <emr-tab-panel-item 
          [for]="'chapter-' + chapter.id" 
          [matTooltip]="chapter.title" 
          matTooltipPosition="after"
          (click)="selectChapter(chapter)">
          <emr-icon name="ph:folder-open" emrTabPanelItemIcon></emr-icon>
        </emr-tab-panel-item>
      }
    </emr-tab-panel-nav>
  </emr-tab-panel-header>

  <!-- Aside content for chapters -->
  <emr-tab-panel-aside>
    @for (chapter of course?.chapters || []; track chapter.id) {
      <ng-template [emrTabPanelAsideContent]="'chapter-' + chapter.id">
        <!-- Content list and display -->
        <div class="content-container">
          <!-- Content list -->
          <div class="content-list">
            <h3>Contents</h3>
            <ul>
              @for (content of chapter.contents; track content.id) {
                <li 
                  [class.active]="selectedContent?.id === content.id"
                  (click)="selectContent(content)">
                  {{ content.title }}
                </li>
              }
            </ul>
            <h3>Quizzes</h3>
            <div *ngIf="chapter.quizzes && chapter.quizzes.length > 0; else noQuizzes">
              <ul>
                @for (quiz of chapter.quizzes; track quiz.quizId) {
                  <li 
                    [class.active]="selectedQuiz?.quizId === quiz.quizId"
                    (click)="selectQuiz(quiz)">
                    {{ quiz.title }}
                  </li>
                }
              </ul>
            </div>
            <ng-template #noQuizzes>
              <p class="no-quizzes">No quizzes available for this chapter</p>
            </ng-template>

            <!-- AI Quiz Generator Button -->
            <div class="ai-quiz-btn-container">
              <button mat-raised-button color="primary" (click)="toggleAIQuizGenerator()" class="ai-quiz-button">
                <mat-icon>psychology</mat-icon>
                <span>AI Quiz Generator</span>
              </button>
            </div>
          </div>

          <!-- Content/Quiz display -->
          <div class="content-display">
            <!-- AI Quiz Generator -->
            <ng-container *ngIf="showAIQuizGenerator">
              <div class="ai-quiz-container">
                <h2>AI Quiz Generator</h2>
                
                <!-- Quiz Generator Form -->
                <div *ngIf="!generatedAIQuiz" class="quiz-form">
                  <mat-card>
                    <mat-card-content>
                      <p class="description">Enter a topic and the AI will generate a quiz based on this chapter's content.</p>
                      
                      <mat-form-field appearance="outline" class="full-width">
                        <mat-label>Quiz Topic</mat-label>
                        <input matInput [(ngModel)]="aiQuizPrompt" placeholder="e.g., HTML Basics, CSS Selectors, JavaScript Functions">
                      </mat-form-field>
                      
                      <div class="error-message" *ngIf="aiQuizErrorMessage">{{ aiQuizErrorMessage }}</div>
                      
                      <button mat-raised-button color="primary" (click)="generateAIQuiz()" [disabled]="generatingAIQuiz">
                        <mat-spinner *ngIf="generatingAIQuiz" diameter="20"></mat-spinner>
                        <span *ngIf="!generatingAIQuiz">Generate Quiz</span>
                      </button>
                    </mat-card-content>
                  </mat-card>
                </div>
                
                <!-- Generated Quiz Display -->
                <div *ngIf="generatedAIQuiz" class="quiz-display">
                  <mat-card>
                    <mat-card-header>
                      <mat-card-title>{{ generatedAIQuiz.title }}</mat-card-title>
                      <mat-card-subtitle>{{ generatedAIQuiz.description }}</mat-card-subtitle>
                    </mat-card-header>
                    
                    <mat-card-content>
                      <div class="quiz-info">
                        <p><strong>Time Limit:</strong> {{ generatedAIQuiz.timeLimit }} minutes</p>
                        <p><strong>Passing Score:</strong> {{ generatedAIQuiz.passingScore }}</p>
                        <p><strong>Max Attempts:</strong> {{ generatedAIQuiz.maxAttempts }}</p>
                      </div>
                      
                      <mat-divider></mat-divider>
                      
                      <!-- Questions -->
                      <div class="questions-container">
                        <div *ngFor="let question of generatedAIQuiz.questions" class="question-item">
                          <h3>Question {{ question.questionId }}: {{ question.questionText }}</h3>
                          <p class="points">({{ question.points }} points)</p>
                          
                          <!-- Multiple Choice Single -->
                          <div *ngIf="question.questionType === 'MULTIPLE_CHOICE_SINGLE'" class="options-container">
                            <mat-radio-group aria-label="Select an option" class="radio-group"
                                          (change)="updateAISingleChoiceResponse(question.questionId!, $event.value)">
                              <mat-radio-button *ngFor="let option of question.options" [value]="option">
                                {{ option }}
                              </mat-radio-button>
                            </mat-radio-group>
                          </div>
                          
                          <!-- Multiple Choice Multiple -->
                          <div *ngIf="question.questionType === 'MULTIPLE_CHOICE_MULTIPLE'" class="options-container">
                            <div *ngFor="let option of question.options" class="checkbox-option">
                              <mat-checkbox 
                                [checked]="isAIMultipleChoiceOptionSelected(question.questionId!, option)"
                                (change)="updateAIMultipleChoiceResponse(question.questionId!, option, $event.checked)">
                                {{ option }}
                              </mat-checkbox>
                            </div>
                          </div>
                        </div>
                      </div>
                    </mat-card-content>
                    
                    <mat-card-actions align="end">
                      <button mat-raised-button color="accent" (click)="checkAIQuizAnswers()">Check Answers</button>
                      <button mat-button (click)="resetAIQuiz()">New Quiz</button>
                    </mat-card-actions>
                  </mat-card>
                </div>
              </div>
            </ng-container>

            <ng-container *ngIf="selectedContent && !showAIQuizGenerator">
              <ng-container [ngSwitch]="selectedContent.type">
                <!-- PDF content -->
                <div *ngSwitchCase="'pdf'">
                  <ng-container *ngIf="selectedContent.downloadUrl; else loadingOrError">
                    <app-pdf-viewer-wrapper
                      [src]="selectedContent.downloadUrl"
                      [renderText]="true"
                      [originalSize]="false"
                      customStyle="width: 1100px; height: 700px;">
                    </app-pdf-viewer-wrapper>
                  </ng-container>
                  <ng-template #loadingOrError>
                    <div class="loading-message">
                      {{ selectedContent.error ? 'Error loading content' : 'Loading PDF...' }}
                    </div>
                  </ng-template>
                </div>

                <!-- Video content -->
                <div *ngSwitchCase="'video'" class="video-container" style="width: 900px; height: 500px;">
                  <ng-container *ngIf="isYoutubeLink(selectedContent.content); else localVideo">
                    <iframe 
                      width="100%" 
                      height="100%"
                      [src]="getSafeYoutubeUrl(selectedContent.content)"
                      frameborder="0"
                      allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                      allowfullscreen>
                    </iframe>
                  </ng-container>
                  <ng-template #localVideo>
                    <video #videoPlayer controls style="width: 100%; height: 100%;">
                      <source [src]="selectedContent.content" type="video/mp4">
                      Your browser does not support the video tag.
                    </video>
                  </ng-template>
                </div>

                <!-- Fallback -->
                <div *ngSwitchDefault>
                  <div class="empty-content">No content available</div>
                </div>
              </ng-container>
            </ng-container>

            <ng-container *ngIf="!selectedContent && selectedQuiz && !showAIQuizGenerator">
              <div class="quiz-display">
                <h3>{{ selectedQuiz.title }}</h3>
                <p>{{ selectedQuiz.description }}</p>
                <div class="quiz-details">
                  <p>Time Limit: {{ selectedQuiz.timeLimit }} minutes</p>
                  <p>Passing Score: {{ selectedQuiz.passingScore }}</p>
                  <p>Max Attempts: {{ selectedQuiz.maxAttempts }}</p>
                </div>

                <!-- Quiz attempt section -->
                <div class="quiz-attempt" *ngIf="!quizSubmitted">
                  <button *ngIf="!attemptInProgress" 
                          (click)="startQuizAttempt()" 
                          class="btn-primary">
                    Start Quiz
                  </button>

                  <div *ngIf="attemptInProgress" class="quiz-questions">
                    <div *ngFor="let question of selectedQuiz.questions" class="question-item">
                      <h4>{{ question.questionText }}</h4>
                      <p class="points">Points: {{ question.points }}</p>

                      <!-- Multiple Choice Single Answer -->
                      <div *ngIf="question.questionType === 'MULTIPLE_CHOICE_SINGLE'" class="options">
                        <div *ngFor="let option of question.options; let i = index" class="option">
                          <input type="radio" 
                                [id]="'q' + question.questionId + 'opt' + i"
                                [name]="'question' + question.questionId"
                                [value]="option"
                                (change)="updateResponse(question.questionId, option)">
                          <label [for]="'q' + question.questionId + 'opt' + i">{{ option }}</label>
                        </div>
                      </div>

                      <!-- Multiple Choice Multiple Answers -->
                      <div *ngIf="question.questionType === 'MULTIPLE_CHOICE_MULTIPLE'" class="options">
                        <div *ngFor="let option of question.options; let i = index" class="option">
                          <input type="checkbox" 
                                [id]="'q' + question.questionId + 'opt' + i"
                                [value]="option"
                                (change)="onMultipleChoiceChange($event, question.questionId, option)">
                          <label [for]="'q' + question.questionId + 'opt' + i">{{ option }}</label>
                        </div>
                      </div>

                      <!-- Short Text Answer -->
                      <div *ngIf="question.questionType === 'SHORT_TEXT'" class="text-answer">
                        <input type="text" 
                              [id]="'q' + question.questionId"
                              (input)="onTextAnswerChange($event, question.questionId)"
                              placeholder="Enter your answer">
                      </div>
                    </div>

                    <button (click)="submitQuiz()" 
                            class="btn-primary submit-quiz"
                            [disabled]="!Object.keys(quizResponses).length">
                      Submit Quiz
                    </button>
                  </div>
                </div>

                <!-- Quiz Results -->
                <div *ngIf="quizSubmitted && quizResult" class="quiz-results">
                  <h4>Quiz Results</h4>
                  <p>Score: {{ quizResult.score }}</p>
                  <p>Status: {{ quizResult.passed ? 'Passed' : 'Failed' }}</p>
                  <button (click)="selectQuiz(selectedQuiz)" class="btn-secondary">
                    Try Again
                  </button>
                </div>
              </div>
            </ng-container>

            <ng-container *ngIf="!selectedContent && !selectedQuiz && !showAIQuizGenerator">
              <div class="empty-content">Select a content item or quiz to view</div>
            </ng-container>
          </div>
        </div>
      </ng-template>
    }
  </emr-tab-panel-aside>
</emr-tab-panel>

<!-- PDF Summarization Button (only shown for PDF content) -->
<div *ngIf="selectedContent?.type === 'pdf' && selectedContent?.downloadUrl && !showPdfSummary" class="pdf-summarize-btn">
  <button mat-fab color="primary" (click)="summarizePdf()" [disabled]="generatingSummary" matTooltip="Summarize this PDF" aria-label="Summarize PDF">
    <mat-icon>summarize</mat-icon>
  </button>
</div>

<!-- PDF Summary Overlay -->
<div *ngIf="showPdfSummary" class="pdf-summary-overlay">
  <div class="pdf-summary-container">
    <div class="pdf-summary-header">
      <h2>Summary of {{ selectedContent?.title }}</h2>
      <button mat-icon-button (click)="closeSummary()" class="close-btn" aria-label="Close summary">
        <mat-icon>close</mat-icon>
      </button>
    </div>
    <div class="pdf-summary-content">
      <div *ngIf="generatingSummary" class="summary-loading">
        <mat-spinner diameter="40"></mat-spinner>
        <p>Generating summary...</p>
      </div>
      <div *ngIf="!generatingSummary" [innerHTML]="pdfSummaryHtml" class="formatted-summary"></div>
    </div>
  </div>
</div>

<style>
  .pdf-info {
    background-color: #f5f5f5;
    padding: 10px;
    margin-bottom: 10px;
    border-radius: 4px;
    font-size: 12px;
    color: #666;
  }
  
  .loading-message {
    display: flex;
    justify-content: center;
    align-items: center;
    height: 200px;
    font-size: 16px;
    color: #666;
  }

  .ai-quiz-btn-container {
    margin-top: 20px;
    padding-top: 15px;
    border-top: 1px solid #eee;
  }

  .ai-quiz-button {
    width: 100%;
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 8px;
  }

  .ai-quiz-container {
    width: 100%;
    max-width: 900px;
    padding: 20px;
  }

  .full-width {
    width: 100%;
  }

  .options-container {
    margin: 15px 0;
  }

  .radio-group {
    display: flex;
    flex-direction: column;
    gap: 10px;
  }

  .checkbox-option {
    margin-bottom: 10px;
  }

  .question-item {
    margin-bottom: 30px;
    padding-bottom: 20px;
    border-bottom: 1px solid #e0e0e0;
  }

  .questions-container {
    margin-top: 20px;
  }

  .points {
    color: #666;
    font-style: italic;
  }

  mat-card-actions {
    padding: 15px;
  }

  /* PDF Summarization styles */
  .pdf-summarize-btn {
    position: fixed;
    bottom: 30px;
    right: 30px;
    z-index: 100;
  }

  .pdf-summary-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.7);
    z-index: 1000;
    display: flex;
    justify-content: center;
    align-items: center;
  }

  .pdf-summary-container {
    width: 900px;
    max-width: 90%;
    max-height: 90vh;
    background-color: white;
    border-radius: 8px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
    display: flex;
    flex-direction: column;
  }

  .pdf-summary-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 15px 20px;
    border-bottom: 1px solid #eee;
  }

  .pdf-summary-header h2 {
    margin: 0;
    font-size: 1.4rem;
    color: #333;
  }

  .pdf-summary-content {
    padding: 20px 30px;
    overflow-y: auto;
    max-height: calc(90vh - 80px);
    line-height: 1.6;
  }
  
  .formatted-summary {
    font-size: 16px;
    color: #333;
    overflow-wrap: break-word;
    white-space: normal;
  }
  
  .formatted-summary p {
    margin-bottom: 18px;
  }
  
  .formatted-summary ul {
    margin: 0 0 16px 0;
    padding-left: 24px;
  }
  
  .formatted-summary li {
    margin-bottom: 8px;
  }

  .summary-loading {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 40px;
  }

  .summary-loading p {
    margin-top: 20px;
    color: #666;
  }

  .close-btn {
    color: #666;
  }

  .content-container {
    display: flex;
    height: 100%;
  }

  .content-list {
    width: 250px;
    padding: 15px;
    border-right: 1px solid #eee;
    overflow-y: auto;
  }

  .content-list h3 {
    margin-top: 20px;
    margin-bottom: 10px;
    font-size: 16px;
    font-weight: 500;
  }

  .content-list ul {
    list-style: none;
    padding: 0;
    margin: 0;
  }

  .content-list li {
    padding: 8px 12px;
    margin-bottom: 5px;
    border-radius: 4px;
    cursor: pointer;
    transition: background-color 0.2s;
  }

  .content-list li:hover {
    background-color: #f5f5f5;
  }

  .content-list li.active {
    background-color: #e3f2fd;
    color: #1976d2;
    font-weight: 500;
  }

  .content-display {
    flex: 1;
    padding: 20px;
    overflow-y: auto;
  }

  .empty-content {
    display: flex;
    justify-content: center;
    align-items: center;
    height: 200px;
    color: #757575;
    font-style: italic;
  }

  .video-container {
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
  }

  .quiz-display {
    max-width: 800px;
  }

  .quiz-details {
    background-color: #f5f5f5;
    padding: 15px;
    border-radius: 4px;
    margin: 15px 0;
  }

  .quiz-attempt {
    margin-top: 20px;
  }

  .quiz-questions {
    margin-top: 20px;
  }

  .options {
    margin: 15px 0;
  }

  .option {
    margin-bottom: 10px;
    display: flex;
    align-items: center;
  }

  .option input {
    margin-right: 8px;
  }

  .text-answer input {
    width: 100%;
    padding: 8px;
    border: 1px solid #ddd;
    border-radius: 4px;
  }

  .submit-quiz {
    margin-top: 30px;
  }

  .quiz-results {
    margin-top: 20px;
    padding: 20px;
    background-color: #f5f5f5;
    border-radius: 4px;
  }

  .btn-primary {
    background-color: #1976d2;
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 4px;
    cursor: pointer;
  }

  .btn-primary:disabled {
    background-color: #ccc;
    cursor: not-allowed;
  }

  .btn-secondary {
    background-color: #757575;
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 4px;
    cursor: pointer;
    margin-top: 10px;
  }
</style>
